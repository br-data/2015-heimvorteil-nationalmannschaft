<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">

  <title>Auswertung bayerische Nationalmannschaft</title>

  <style type="text/css">
    
    html, body, main {
      height: 100%; 
    }

    main {
      padding: 1em 2em;
      max-width: 940px;
      max-height: 680px;
    }

    button {
      font-size: 1em;
      padding: .5em;
      cursor: pointer;
    }

    button:hover {
      color: #666;
    }

    textarea {
      font-family: monospace;
      margin-top: 2em;
      height: 50%;
      width: 100%;
    }
  </style>

  <script type="text/javascript" src="../bower_components/miso.dataset/dist/miso.ds.deps.min.0.4.1.js"></script>
  <script type="text/javascript" src="../bower_components/filesaver/FileSaver.min.js"></script>
  <script type="text/javascript" src="../bower_components/bower-microajax/microajax.minified.js"></script>
  </head>

  <body>

    <main>

      <h2>Auswertung bayerische Nationalmannschaft</h2>

      <form>
        <button type="button" id="get-data">Auswerten</button>
        <button type="button" id="save-file">Tabelle herunterladen</button>
      </form>

      <p id="result"></p>

    </main>

    <script>
      (function () {
        'use strict';

        var key = '1Flk6E-hy1aHmIno3nkp9n8f2eFBYu4E4Q1tRKCNBheI';
        var worksheet = '1';
        var blob;

        document.getElementById('get-data').onclick = getSpreadsheet;
        document.getElementById('save-file').onclick = saveFile;

        //getSpreadsheet(analyseData);
        getJson('testdata.json', analyseData)

        function analyseData(data) {

          console.log('Formations: ', countFormations(data));
          console.log('Players: ', countPlayers(data));
          console.log('Positions: ', countPositions(data));
        }

        function getSpreadsheet(callback) {

          var ds = new Miso.Dataset({

            importer: Miso.Dataset.Importers.GoogleSpreadsheet,
            parser: Miso.Dataset.Parsers.GoogleSpreadsheet,
            key: key,
            worksheet: worksheet
          });

          ds.fetch({

            success : function() {

              callback(convertData(ds.toJSON()));
            },
            error : function() {

              outputData("Daten konnten nicht geladen werden. Vielleicht sind Sie nicht mit dem Internet verbunden oder das Spreadsheet wurde nicht ver√∂ffentlicht.");
            }
          });
        }

        function getJson(path, callback) {

          microAjax(path, function (res) {

            callback(JSON.parse(res));
          });
        }

        function convertData(data) {

          for (var entry = 0; entry < data.length; entry++) {

            var hash = data[entry].Lineup;
            var timestamp = new Date(data[entry].Timestamp['_d']);
            var lineup = data[entry].Lineup.split('-');
            
            for (var row = 0; row < lineup.length; row++) {

              lineup[row] = lineup[row].match(/.{1,2}/g);
            }

            data[entry] = {

              hash: hash,
              timestamp: timestamp,
              lineup: lineup
            };
          }

          return data;
        }

        function countFormations(data) {

          var formations = [];

          for (var entry = 0; entry < data.length; entry++) {

            var formation = [];

            var lineup = data[entry].lineup;

            lineup.reverse();

            // Start at 1 to remove the goalkeeper
            for (var row = 1; row < lineup.length; row++) {

              formation.push(lineup[row].length);
            }

            formations.push(formation.join('-'));
          }
          
          formations = count(formations);
          formations = toArray(formations);

          return formations;
        }

        function countPlayers(data) {

          var players = [];

          for (var entry = 0; entry < data.length; entry++) {


            players.push(flatten(data[entry].lineup));
          }

          return getCount(players);
        }

        function countPositions(data) {

          var strikers = [];
          var midfielders = [];
          var defenders = [];
          var goalkeepers = [];

          for (var entry = 0; entry < data.length; entry++) {

            var lineup = data[entry].lineup;

            if (lineup.length === 4) {

              strikers.push(lineup[0]);
              midfielders.push(lineup[1]);
              defenders.push(lineup[2]);
              goalkeepers.push(lineup[3]);
            } else if (lineup.length === 5) {

              strikers.push(lineup[0]);
              midfielders.push(lineup[1]);
              midfielders.push(lineup[2]);
              defenders.push(lineup[3]);
              goalkeepers.push(lineup[4]);
            } else {

              console.log('Weird linup detected:', lineup);
            }
          }

          return {

            strikers: getCount(strikers),
            midfielders: getCount(midfielders),
            defenders: getCount(defenders),
            goalkeepers: getCount(goalkeepers)
          };
        }

        function getCount(players) {

          players = flatten(players);
          players = count(players);
          players = clean(players);
          players = toArray(players);
          players = sort(players).reverse();

          return players;
        }

        function flatten(arr) {

          var flat = [];

          return flat.concat.apply(flat, arr);
        }

        function count(arr) {

          var counts = {};

          arr.forEach( function(n) {

            counts[n] = (counts[n] || 0) + 1;
          });

          return counts;
        }

        function toArray(obj) {

          var arr = [];

          for (var key in obj) {

            arr.push([key, obj[key]]);
          }

          return arr;
        }

        function sort(arr) {

          return arr.sort(

            function(a, b) {

              return a[1] - b[1];
            });
        }

        function clean(obj) {

          for (var key in obj) {

            if (!key.indexOf('z')) {

              delete obj[key];
            }
          }

          return obj;
        }

        function outputData(string) {

          document.getElementById('result').textContent = string;
          blob = new Blob([string], {type: 'application/json;charset=utf-8'});
        }

        function toCSV(objArray) {

            var arr = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < arr.length; i++) {

              var line = '';

              for (var key in arr[i]) {

                if (line !== '') {

                  line += ',';
                }

                line += arr[i][key];
              }

              str += line + '\r\n';
            }

            return str;
        }

        function saveFile() {

          if (blob) {

            saveAs(blob, 'data.json');
          } else {

            getSpreadsheet();
          }
        }
      }());
     
    </script>

  </body>

</html>